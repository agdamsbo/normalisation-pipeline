<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Normalisation pipeline - 1&nbsp; Data processing for brain and lesion normalisation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./index.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./README.html"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Data processing for brain and lesion normalisation</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Normalisation pipeline</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/agdamsbo/normalisation-pipeline/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./README.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Data processing for brain and lesion normalisation</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#requirements" id="toc-requirements" class="nav-link active" data-scroll-target="#requirements"><span class="header-section-number">2</span> Requirements</a>
  <ul class="collapse">
  <li><a href="#files-required-for-each-subject" id="toc-files-required-for-each-subject" class="nav-link" data-scroll-target="#files-required-for-each-subject"><span class="header-section-number">2.1</span> Files required for each subject</a></li>
  </ul></li>
  <li><a href="#contents" id="toc-contents" class="nav-link" data-scroll-target="#contents"><span class="header-section-number">3</span> Contents</a></li>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started"><span class="header-section-number">4</span> Getting started</a>
  <ul class="collapse">
  <li><a href="#file-structure" id="toc-file-structure" class="nav-link" data-scroll-target="#file-structure"><span class="header-section-number">4.1</span> File structure</a></li>
  </ul></li>
  <li><a href="#source-and-acknowledgements" id="toc-source-and-acknowledgements" class="nav-link" data-scroll-target="#source-and-acknowledgements"><span class="header-section-number">5</span> Source and acknowledgements</a>
  <ul class="collapse">
  <li><a href="#notes-on-changes-from-the-originals" id="toc-notes-on-changes-from-the-originals" class="nav-link" data-scroll-target="#notes-on-changes-from-the-originals"><span class="header-section-number">5.1</span> Notes on changes from the originals</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/agdamsbo/normalisation-pipeline/edit/main/README.md" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Data processing for brain and lesion normalisation</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This pipeline was comprised as part of my exchange stay at the Brain Behavior Lab at UBC, Vancouver, Canada. It is my hope that the notes and script may be of help to others, myself being a new learner to FSL and everything around it.</p>
<p>The reason for creating this tool is to use 1mm MNI normalised lesion masks for the <a href="https://kuceyeski-wcm-web.s3.us-east-1.amazonaws.com/upload.html">NeMo tool</a>.</p>
<p>Most of the hard working scripts in this pipeline are based on the work by <a href="https://neuroimaging-core-docs.readthedocs.io/en/latest/index.html">Dr.&nbsp;Dianne Patterson, PhD</a>. I have tried my best at modifying the original scripts as little as possible for clarity, and instead created a few new scripts to work as wrappers.</p>
<p>The pipeline provides a set of handy tools listed below, which I will also go through:</p>
<ul>
<li><p>R-script to organise files into subject-folders</p></li>
<li><p>Shell pipeline to process all subject folders to extract brain mask, and normalise lesion mask to 1 mm MNI space (this is the primary content)</p></li>
<li><p>Shell-script to normalise lesion mask after manual correction of brain mask (no, even using optiBET is not perfect)</p></li>
<li><p>R-script to package lesion masks to supply to the NeMo tool.</p></li>
</ul>
<section id="requirements" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Requirements</h1>
<p>You need to have fsl as well as <em>R</em> installed.</p>
<section id="files-required-for-each-subject" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="files-required-for-each-subject"><span class="header-section-number">2.1</span> Files required for each subject</h2>
<p>The scripts needs a T1 weighted scan and lesion mask in Nifti format. Naming should be as follows.</p>
<ul>
<li>subjID_T1w.nii.gz</li>
<li>subjID_LesionMask.nii.gz</li>
</ul>
</section>
</section>
<section id="contents" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Contents</h1>
<p>Script files are located in the <code>codes</code> folder.</p>
<pre><code>${ROOT}
|-- codes
   |-- 00nemo_prep_pipeline.sh
   |-- file-structure.R
   |-- fsl_1mm-norm_bbl.sh
   |-- fsl_anat_alt_bbl.sh
   |-- modified_brain_mask_bbl.sh
   |-- nemo-packing.R
   |-- optiBET.sh
   |-- prep_T1w_bbl.sh
   |-- T1_2_MNI152_1mm.cnf
|-- ...</code></pre>
<p>Move the contents of the <code>codes</code> folder to where you want your files to be located.</p>
</section>
<section id="getting-started" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Getting started</h1>
<p>Open a terminal window in the root directory.</p>
<ol type="1">
<li><p>Start by copying a new configuration file for fsl, to do registration to 1mm MNI space (basically the same as the 2mm config, but references the 1mm MNI):</p>
<pre><code>imcp T1_2_MNI152_1mm.cnf $FSLDIR/etc/flirtsch/T1_2_MNI152_1mm.cnf</code></pre>
<p>See <a href="https://www.jiscmail.ac.uk/cgi-bin/webadmin?A2=fsl;2fa01b76.1208">this mail thread</a> for a note on the 1mm normalization. It is needed for the NeMo-tool however.</p></li>
<li><p>Open the <code>file-prep.R</code> script and edit the first three variables. Save it and then, run the following in the terminal window:</p>
<pre><code>Rscript file-prep.R</code></pre>
<p>Instructions are in this file.</p>
<p>Now the files and folders are structured as expected.</p></li>
<li><p>In a terminal window, make sure your in the source directory, where your codes and scans are located.</p>
<pre><code>sh 00nemo_prep_pipeline.sh</code></pre>
<p>Then, when ready to start processing your data, fire up the main script, and watch while your computer hums away. Or do something else in the meantime. You’ll get time stamps along the way to have an idea of the progress and the time needed. The output files are written along the way, so you can manually check the output while the script works. Note that your original T1 and lesion mask will have “_orig” appended as suffix and be substituted with corrected files. If the script gets interrupted, you can just restart it, and it will skip subjects already processed. Make sure you delete the output files, if you want the script to rerun on a specific subject.</p></li>
<li><p>As quality control of the registration, I would open the new “SubNN_T1w.nii.gz” in fsleyes or ITK-SNAP and overlay the “SubNN_T1w_brain_mask.nii.gz” and go through to check the masking and cropping.</p>
<ul>
<li><p>Regarding masking: In ITK-SNAP, you can correct the brain mask manually. Working in a different label from the brain mask, you can mark additional brain area using the interpolate tool. The tool is demonstrated <a href="https://youtu.be/watch?v=ZVmINdWk5R4">here</a>. Save the new mask with a new name. Subtracting brain mask would be done manually, I believe. Please share, if you have a better approach.</p>
<p>Having a new, modified brain mask, go to the terminal window again and write the following:</p>
<pre><code>sh modified_brain_mask_bbl.sh SubNN/SubNN_T1w.nii.gz SubNN/MODIFIED_T1w_brain_mask.nii.gz</code></pre>
<p>Please notice that the naming of the modified brain mask doesn’t matter.</p></li>
<li><p>Regarding cropping: Delete all the output-files (remembering that the original files were preserved with “_orig” suffix) and renaming the original files removing the suffix. Open the original T1 image and lesion mask in fsleyes, and manually crop the two with the same mask. After cropping, run the <code>00nemo_prep_pipeline.sh</code> script again.</p></li>
</ul></li>
<li><p>Now you should be ready to package for the NeMo tool. The web interface has an upload limit of 10 lesion masks. Open and edit the source-folder in the <code>nemo-packing.R</code> script. It will collect all 1mm MNI lesion masks and package in zip-files of max 10 lesion masks each and put them in the provided folder. Save and then run the following:</p>
<pre><code>Rscript nemo-packing.R</code></pre></li>
</ol>
<section id="file-structure" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="file-structure"><span class="header-section-number">4.1</span> File structure</h2>
<p>This is the expected data structure for the pipeline.</p>
<pre><code>${ROOT}
|-- 00nemo_prep_pipeline.sh
|-- file-prep.R
|-- fsl_1mm-norm_bbl.sh
|-- fsl_anat_alt_bbl.sh
|-- optiBET_bbl.sh
|-- prep_T1w_bbl.sh
|-- T1_2_MNI152_1mm.cnf
|-- sub01
    |-- sub01_T1w.nii.gz
    |-- sub01_LesionMask.nii.gz
|-- sub02
    |-- sub02_T1w.nii.gz
    |-- sub02_LesionMask.nii.gz
|-- subNN
    |-- subNN_T1w.nii.gz
    |-- subNN_LesionMask.nii.gz</code></pre>
</section>
</section>
<section id="source-and-acknowledgements" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Source and acknowledgements</h1>
<p>Scripts for normalization: <a href="https://neuroimaging-core-docs.readthedocs.io/en/latest/pages/lesion_normalization.html">link</a></p>
<p>NeMo tool upload: <a href="https://kuceyeski-wcm-web.s3.us-east-1.amazonaws.com/upload.html">link</a></p>
<section id="notes-on-changes-from-the-originals" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="notes-on-changes-from-the-originals"><span class="header-section-number">5.1</span> Notes on changes from the originals</h2>
<p><strong>fsl_anat_alt_bbl.sh</strong>: It took me some time to figure out, I have to say. During the script, the working directory is changed. This makes referencing the optiBET_bbl.sh script a little tricky. I ended up going back a step with “cd -” and forward again after running optiBET_bbl.sh.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./index.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Preface</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->



</body></html>